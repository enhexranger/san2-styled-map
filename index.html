<html>
<head>
	<title>san2 styled map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
<style>
html, body {
    height: 100%;
    margin: 0;
    padding: 0;
}

/*
.container, .container > div, .container > div #map-canvas {
	position: relative;
    height: inherit;
    width: inherit;
}
*/
#map-canvas {
    height: 100%;
    width: 100%;
}

img.lat {
	zoom: 5;
	image-rendering: pixelated;
}

#css_table {
      display: table;
	  height: 100%;
	  width: 100%;
  }
.css_tr {
      display: table-row;
  }
.css_td {
      display: table-cell;
	  width: 50%;
	  background-color: antiquewhite;
  }

input.active {
	background-color: yellow;
}  

input.fr {
	width: 30px;
	background-repeat: no-repeat;
    background-size: cover;
}

input.fr.even {
	position: relative;
	top: 11px;
}

input.fr.mountain {
	background-color: #C29565;
	background-image: url('https://raw.githubusercontent.com/enhexranger/san2-styled-map/main/icon/mountain.png');
}
input.fr.tree {
	background-color: #98D800;
	background-image: url('https://raw.githubusercontent.com/enhexranger/san2-styled-map/main/icon/tree.png');
}
input.fr.grass {
	background-color: #d2eb9d;
	background-image: url('https://raw.githubusercontent.com/enhexranger/san2-styled-map/main/icon/grass.png');
}
input.fr.water {
	background-color: lightskyblue;
	background-image: url('https://raw.githubusercontent.com/enhexranger/san2-styled-map/main/icon/water.png');
}
input.fr.hill {
	background-color: lightsalmon;
	background-image: url('https://raw.githubusercontent.com/enhexranger/san2-styled-map/main/icon/hill.png');
}
input.fr.castle {
	background-color: rgb(228, 66, 74);
	background-image: url('https://raw.githubusercontent.com/enhexranger/san2-styled-map/main/icon/castle.png');
}
input.fr.city {
	background-color: rgb(47, 0, 255);
	background-image: url('https://raw.githubusercontent.com/enhexranger/san2-styled-map/main/icon/city.png');
}

input.fr.dq2s1 {
	background-color: rgb(202, 206, 171);
	background-image: url('https://raw.githubusercontent.com/enhexranger/san2-styled-map/main/icon/dq2s1.png');
}

input.fr.dq2w3 {
	background-color: rgb(142, 178, 212);
	background-image: url('https://raw.githubusercontent.com/enhexranger/san2-styled-map/main/icon/dq2w3.png');
}

</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.5.0/proj4.js"></script>
<script>

let latlng_map_tile = {};

((c)=>{

const _list1 = {
'mountain':['嶺','https://raw.githubusercontent.com/enhexranger/san2-styled-map/main/icon/mountain.png']
,'hill':['丘','https://raw.githubusercontent.com/enhexranger/san2-styled-map/main/icon/hill.png']
,'castle':['關','https://raw.githubusercontent.com/enhexranger/san2-styled-map/main/icon/castle.png']
,'city':['城','https://raw.githubusercontent.com/enhexranger/san2-styled-map/main/icon/city.png']
,'water':['水','https://raw.githubusercontent.com/enhexranger/san2-styled-map/main/icon/water.png']
,'grass':['草','https://raw.githubusercontent.com/enhexranger/san2-styled-map/main/icon/grass.png']
,'tree':['林','https://raw.githubusercontent.com/enhexranger/san2-styled-map/main/icon/tree.png']
,'dq2s1':['沙','https://raw.githubusercontent.com/enhexranger/san2-styled-map/main/icon/dq2s1.png']
,'dq2w3':['礁','https://raw.githubusercontent.com/enhexranger/san2-styled-map/main/icon/dq2w3.png']
,'empty':[' ','']
};	

const _list2 = ['mountain','hill','grass','tree','water','castle','city','dq2s1','dq2w3'];

const _grid = {
	'km_10': { 'max': 1, 'per': 0.1, 'name':'10 km', 'id':'km_10', 'metre':10000 },
	'km_1': { 'max': .1, 'per': 0.01, 'name':'1 km', 'id':'km_1', 'metre':1000 },
	'm_100': { 'max': .01, 'per': 0.001, 'name':'100m', 'id':'m_100', 'metre':100 }
};

const _colorSet = {
	'grid': {
		strokeColor: "yellow",
		strokeOpacity: .8,
		strokeWeight: 1
	},
	'GM': {
		strokeColor: "red",
		strokeOpacity: 1,
		strokeWeight: 1
	}
};

const _multiple = 5 ;

let _gridNow = _grid['km_10'];

let _isGM = false;

let _isOD = true; // Odd Diff
 
let _markersMap = {};

let _kml = {
	'click' : {'boxs':[],'lines':[]},
	'load' : {'boxs':[],'lines':[]}
};

function round(value, decimals) { 
  switch(decimals){
    case 'xy': decimals = 2; break;
    case 'll': decimals = 6; break;
    case undefined : decimals = 0; break;
    default: decimals = parseInt(decimals);
  }
  decimals = isNaN(decimals) ? 0 : decimals;
  return Number(Math.round(value+'e'+decimals)+'e-'+decimals);
}

function floor(value, decimals) { 
  return Number(Math.floor(value+'e'+decimals)+'e-'+decimals);
}

function getLatlng(lat,lng){
var latlng = new google.maps.LatLng(lat,lng);
return latlng;
}

function drawMarker(latlng,map,markers){
	
	var marker = new google.maps.Marker(
    { position: latlng
      ,icon: {'url':"http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png"}
      ,title: latlng.toString()
	} );

	marker.setMap(map);
	markers.push(marker);
}


function drawLine(latlngs,map,polylines,option){

	var polyline = new google.maps.Polyline({
        path: latlngs
      });
	var optionNow = {
      strokeColor: "#00FF00",
      strokeOpacity: 0.8,
      strokeWeight: 2
    };
	if(option) optionNow = option;
    polyline.setOptions(optionNow);
	polyline.setMap(map);
	polylines.push(polyline)
	
}

let getDecimal = (max)=>{
	return (max).toString().split('.')[1] ? (max).toString().split('.')[1].length : 0 ;
};

let getOddExt = (d,lng)=>{
	return parseFloat(floor(lng,d)+('e'+d))%2!=0 ? 1 : 0;
};

let getXmlDoc = (id)=>{
	var parser = new DOMParser();
	var str = document.getElementById(id).value;
	// clear tab & end line not necessary
	var strA = str.replace(/\r\n|\r|\n|\t/gm, '');
	var xmlDoc = parser.parseFromString(strA, 'text/xml');
	return xmlDoc;
};

let putXmlDoc = (id,xmlDoc)=>{
	var xmlString = (new XMLSerializer()).serializeToString(xmlDoc);
	document.getElementById(id).value = xmlString;
};

let arrNextIndex = (arr,v,k)=>{
	var i = !isNaN(k) ? arr.findIndex(x=>x[k]==v) : arr.findIndex(x=>x==v) ;
	return i==(arr.length-1) ? 0 : i+1 ;
};

let getLatlngWS = (latlng)=>{

	var lat = latlng.lat();
	var lng = latlng.lng();
	var max = _gridNow['max'];
			
	// when lng is odd, lat + half
	var d = getDecimal(max);
	var oe = getOddExt(d,lng);
	// base west south point
	var lat0 = parseFloat(floor(lng,d)+('e'+d))%2!=0 ? round(round(lat,d) - max/2,d+oe) : floor(lat,d);
	// !_isOD override
	if(!_isOD) lat0 = floor(lat,d);
	var lng0 = floor(lng,d);
	
	return getLatlng(lat0,lng0);
};

let getENWS = (en)=>{
	var e = en[0], n = en[1];
	var per = _gridNow['per'];	
	var div = parseInt(_gridNow['max']/per);
	var max = _gridNow['metre'] * div;
	var e0 = parseInt(e/max)*max;
	var n0 = parseInt(e/max)%2==0 ? parseInt((n-max/2)/max)*max+max/2 : parseInt(n/max)*max ;
	// !_isOD override
	if(!_isOD) n0 = parseInt(n/max)*max;
	return [e0,n0];
};

c.gridLevelChange = ()=>{
	var input = document.getElementById('grid_level');
	var name=input.value, names = [];
	for(var k in _grid) names.push([k,_grid[k]['name']]);
	var j = arrNextIndex(names,name,1);
	input.value = names[j][1];
	
	_gridNow = _grid[names[j][0]];
};

c.isOD = (e)=>{
	// toggle class
	var btn = e.target;
	if(_isOD){
		_isOD = false;
		btn.classList.remove('active');
	}else{
		_isOD = true;
		btn.classList.add('active');
	}
	// html grid toggle class
	var fg = document.getElementById('feature_grid');
	
	let csP = (arr)=>{
		for(var i=0;i<arr.length;i++){
			var r = arr[i];
			var cl = r.classList;
			if(_isOD == false && cl[1]) cl.remove('even');
			if(i%2==1 && _isOD == true) cl.add('even');
		}
	};
	
	for(var i=0; i<fg.children.length;i++){
		var row = fg.children[i];
		var cs = row.children;
		csP(cs);
	}
	
};

c.isGM = (e)=>{
	var btn = e.target;
	if(_isGM){ 
		_isGM = false;
		btn.style='background:initial';
	}else{
		_isGM = true;
		btn.style='background:yellow';
	} 
};

const proj4_Defs = ()=>{
	// ESPG:3857 google map mercator
	const n ="EPSG:3857";
	const zdef = "+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs";

	proj4.defs([
  [
    "EPSG:4326",
    "+title=WGS 84 (long/lat) +proj=longlat +ellps=WGS84 +datum=WGS84 +units=degrees"
  ],
  [n, zdef]]);
  
	};

const ll2GM = (ll)=>{
	let lat = ll[0], lon = ll[1];
	const en_m = proj4("EPSG:4326", "EPSG:3857", [lon, lat]);
  	const e0 = en_m[0].toFixed(0); //easting
  	const n0 = en_m[1].toFixed(0); //northing
	return [e0,n0];
	};

const gM2ll = (en_m) =>{
	var r = proj4("EPSG:3857", "EPSG:4326", en_m); 
	return [r[1],r[0]];
};

const getLLR = (ll,d)=>{
	return [round(ll[0],d),round(ll[1],d)];
};

let grid_KML = (box,lines)=>{
	// load kml
var xmlDoc = getXmlDoc('kml_in');

var placemarks = xmlDoc.getElementsByTagName('Placemark');
var polygons = xmlDoc.getElementsByTagName('Polygon');
// kml name
var name = box.name;
var names = xmlDoc.getElementsByTagName('name');
names[0].textContent = 'san2-'+name;
names[names.length-1].textContent = name;
// polygon value
var txts = [];
box.latlngs.map((a,i)=>{txts.push(a.lng()+','+a.lat()+',0')});
	// coordinate
	polygons[0].getElementsByTagName('coordinates')[0].textContent = txts.join(' ');
// line
for(var i = 0 ; i < lines.length; i++){
	var line = lines[i];
	var txts = [];
	line.latlngs.map((a,i)=>{txts.push(a.lng()+','+a.lat()+',0')});
	var placemark = placemarks[0].cloneNode(true);
	placemark.getElementsByTagName('name')[0].textContent = line.name;
	placemark.getElementsByTagName('coordinates')[0].textContent = txts.join(' ');
	xmlDoc.getElementsByTagName('Folder')[0].appendChild(placemark);
	}
// remove sample placemark
var x = xmlDoc.getElementsByTagName("Placemark")[0];
x.parentNode.removeChild(x);
// delete default groundoverlay
var x = xmlDoc.getElementsByTagName("GroundOverlay")[0];
x.parentNode.removeChild(x);

putXmlDoc('kml_out',xmlDoc);

};

let gridInfo = (x,y,o)=>{

	var infoElem = document.getElementById('info'); 
	
	var exec = {
		'latlng':()=>{
			var lat0 = x, lng0 = y, per=_gridNow.per;
			var info = 'WestSouth: ' + round(lat0, 6) + ',' + round(lng0, 6) + "<br/>";
			var arr = ['KML Box coor: ', [lng0, lat0, 0],
				[lng0, lat0+per, 0],
				[lng0+per, lat0+per, 0],
				[lng0+per, lat0, 0],
				[lng0, lat0, 0]];
			infoElem.innerHTML = info + arr.join(' ');
		},
		'en':()=>{
			var e0 = x, n0 = y;
			var info = 'WestSouth Easting,Northing: ' + round(e0, 0) + ',' + round(n0, 0) + "<br/>";
			infoElem.innerHTML = info ;
		}
	};

	exec[o]();
};

c.grid_GM_latlng = (latlngA)=>{

// from assigned
if(latlngA.lat){
	var latlngC = getLatlng(latlngA.lat()+_gridNow['max']/2,latlngA.lng()+_gridNow['max']/2)
	var latlng = getLatlngWS(latlngC);
	var lat0 = latlng.lat();
	var lng0 = latlng.lng();
}else{
	// chk grid
	if(!_kml['click']['boxs'][0]){alert('no latlng grid'); return false;}
	// from box
	var box = _kml['click']['boxs'][0];
	var lat0 =  box.latlngs[0].lat();
	var lng0 = box.latlngs[0].lng();
}
if(lat0==90){alert('error');return false;} 

// box down lat, right lng
var boxDownLat = lat0 - _gridNow['max'];  
var boxRightLng = lng0 + _gridNow['max'];

proj4_Defs();

var en = ll2GM([lat0,lng0]);
var enDown = ll2GM([boxDownLat,lng0]);
var enRight = ll2GM([lat0,boxRightLng]);
var div = parseInt(_gridNow['max']/_gridNow['per']);

var per = _gridNow['metre'];
var max = parseInt(div*per);
var en0 = [parseInt(en[0]/per)*per,parseInt(en[1]/per)*per];
var enDown0 = [parseInt(enDown[0]/per)*per,parseInt(enDown[1]/per)*per];
var enRight0 = [parseInt(enRight[0]/per)*per,parseInt(enRight[1]/per)*per];

var cDiff = parseInt((en0[1]-enDown0[1]-div*per)/per);
var rDiff = parseInt((enRight0[0]-en0[0]-div*per)/per);

var news = {'ws':en0,'wn':[en0[0],en0[1]+max],'en':[en0[0]+max,en0[1]+max],'es':[en0[0]+max,en0[1]]};
var boxEN = [news.ws,news.wn,news.en,news.es,news.ws];
var box = {'name':news.ws[0]+','+news.ws[1],'latlngs':[]};
var d = 6;
boxEN.map(x=>{
	var ll = gM2ll(x);
	var llr = getLLR(ll,d);
	var latlng = getLatlng(llr[0],llr[1]);
	box.latlngs.push(latlng);
	});

// grid info
gridInfo(en0[0],en0[1],'en');

// draw box
drawLine(box.latlngs,c.map,c.features.polylines);

// collect every ws pt starting from west-north
// even or odd determined by easting
var od = parseInt(en[0]/per)%2 ? 'odd' : 'even' ;

var cols=[], en1=[news.wn[0],news.wn[1]-per], lines=[];
var colsMax = div+cDiff, rowsMax = div+rDiff;

for(var i=0; i < colsMax ; i++){
	var row=[];
	for(j=0; j < rowsMax ; j++){ 
		var x = en1[0]+per*j;
		var y = en1[1]-per*i;
		// when row even shifting half -
		if(j%2!=0) y = en1[1]-per*i - per/2;
		// !isOD revert
		if(!_isOD) y = en1[1]-per*i;
		if(od=='odd') y+=per/2; // only about cDiff & rDiff base on latlng grid 
		// wn xy to grid
		var n = {'sw':[x,y]
				,'wn':[x,y+per]
				,'en':[x+per,y+per]
				,'es': [x+per,y]
			};
		// convert to latlng
		var ll = gM2ll(n.sw);
		var llr = getLLR(ll,d);
		n.sw = getLatlng(llr[0],llr[1]);
		var ll = gM2ll(n.wn);
		var llr = getLLR(ll,d);
		n.wn = getLatlng(llr[0],llr[1]);
		var ll = gM2ll(n.en);
		var llr = getLLR(ll,d);
		n.en = getLatlng(llr[0],llr[1]);
		var ll = gM2ll(n.es);
		var llr = getLLR(ll,d);
		n.es = getLatlng(llr[0],llr[1]);
		var latlngs = [n.sw,n.wn,n.en,n.es,n.sw];
		drawLine(latlngs,c.map,c.features.polylines,_colorSet.GM);
		
		row[j]={'name':x+','+y,'latlngs':latlngs};
		lines.push(row[j]);
	}
	cols[i]=row;
	}

// grid kml
grid_KML(box,lines);

return {'boxs':[box],'lines':lines,'cols':cols};
};

c.grid_GM = (e)=>{

	var lat = e.latLng.lat();
	var lng = e.latLng.lng();

proj4_Defs();

var en = ll2GM([lat,lng]);
var en0 = getENWS(en);

var div = parseInt(_gridNow['max']/_gridNow['per']);
var per = _gridNow['metre'];
var max = parseInt(div*per);

var news = {'ws':en0,'wn':[en0[0],en0[1]+max],'en':[en0[0]+max,en0[1]+max],'es':[en0[0]+max,en0[1]]};
var boxEN = [news.ws,news.wn,news.en,news.es,news.ws];
var box = {'name':news.ws[0]+','+news.ws[1],'latlngs':[]};
var d = 6;
boxEN.map(x=>{
	var ll = gM2ll(x);
	var llr = getLLR(ll,d);
	var latlng = getLatlng(llr[0],llr[1]);
	box.latlngs.push(latlng);
	});

// clear lines
c.features.polylines.map(x=>x.setMap(null));
c.features.polylines.length = 0;	
// info
gridInfo(en0[0],en0[1],'en');
// draw box
drawLine(box.latlngs,c.map,c.features.polylines);

// collect every ws pt starting from west-north

var cols=[], en1=[news.wn[0],news.wn[1]-per], lines=[];
var colsMax = div, rowsMax = div;

for(var i=0; i < colsMax ; i++){
	var row=[];
	for(j=0; j < rowsMax ; j++){ 
		var x = en1[0]+per*j;
		var y = en1[1]-per*i;
		// when row even shifting half -
		if(j%2!=0) y = en1[1]-per*i - per/2;
		// !_isOD revert
		if(!_isOD) y = en1[1]-per*i;
		// wn xy to grid
		var n = {'sw':[x,y]
				,'wn':[x,y+per]
				,'en':[x+per,y+per]
				,'es': [x+per,y]
			};
		// convert to latlng
		var ll = gM2ll(n.sw);
		var llr = getLLR(ll,d);
		n.sw = getLatlng(llr[0],llr[1]);
		var ll = gM2ll(n.wn);
		var llr = getLLR(ll,d);
		n.wn = getLatlng(llr[0],llr[1]);
		var ll = gM2ll(n.en);
		var llr = getLLR(ll,d);
		n.en = getLatlng(llr[0],llr[1]);
		var ll = gM2ll(n.es);
		var llr = getLLR(ll,d);
		n.es = getLatlng(llr[0],llr[1]);
		var latlngs = [n.sw,n.wn,n.en,n.es,n.sw];
		drawLine(latlngs,c.map,c.features.polylines,_colorSet.GM);
		
		row[j]={'name':x+','+y,'latlngs':latlngs};
		lines.push(row[j]);
	}
	cols[i]=row;
	}

// grid kml
grid_KML(box,lines);

return {'boxs':[box],'lines':lines,'cols':cols};
};

c.load_GM = (x)=>{

 // process xml
 var xmlDoc = getXmlDoc('data');

var gos=[], groundOverlays = xmlDoc.getElementsByTagName('GroundOverlay');
var d = 6; // .1 metre
// round
for(var i=0, total=groundOverlays.length; i < total;i++){
	var go = groundOverlays[i];
	var southStr = go.getElementsByTagName('south')[0].textContent;
	var westStr = go.getElementsByTagName('west')[0].textContent;
	var northStr = go.getElementsByTagName('north')[0].textContent;
	var eastStr = go.getElementsByTagName('east')[0].textContent;
	var name = go.getElementsByTagName('name')[0].textContent;
	var south = round(parseFloat(southStr),d);
	var west = round(parseFloat(westStr),d);
	var north = round(parseFloat(northStr),d);
	var east = round(parseFloat(eastStr),d);
	var obj = {'south': south,
				'west': west,
				'north': north,
				'east': east,
				'name': name,
				'go': go	
			};
	gos[i] = obj;
	// rewrite round value
	go.getElementsByTagName('south')[0].textContent = south;
	go.getElementsByTagName('west')[0].textContent = west;
	go.getElementsByTagName('north')[0].textContent = north;
	go.getElementsByTagName('east')[0].textContent = east;		
	} 

// sort 
var ascendWest = (a,b)=>{return a['west']-b['west']}; // 小到大
var descendSouth = (a,b)=>{return b['south']-a['south']}; // 大到小

gos.sort(ascendWest);
gos.sort(descendSouth);

// append to folder named features
var txt='feature', featuresFolder = undefined, folders = xmlDoc.getElementsByTagName('Folder');
for(var i=0;i<folders.length;i++){
	if(folders[i].children[0].textContent == txt) featuresFolder = folders[i];
}
if(featuresFolder == undefined) featuresFolder = xmlDoc.getElementsByTagName('Document')[1];
for(var i=0, total=gos.length; i < total;i++) featuresFolder.appendChild(gos[i]['go']); 

putXmlDoc('data',xmlDoc);

// call click_grid
var load = {};

	var polygon = xmlDoc.getElementsByTagName('Polygon')[0];
	if(!polygon){alert('no polygon');return false;}
	var coor = polygon.getElementsByTagName('coordinates')[0];
	var arr = coor.textContent.split(' ')[0].split(',');
	var e = {'latLng': getLatlng(arr[1],arr[0]) };

	if(x==1){
		load = c.grid_GM_latlng(e);
	}else{
		load = c.grid_GM(e);
	}
	
// fit bound with grid
	var boxs = load['boxs'], bounds = new google.maps.LatLngBounds();
	bounds.extend(boxs[0].latlngs[0]);
	bounds.extend(boxs[0].latlngs[2]);
	c.map.fitBounds(bounds);

//clear marker first
var markers = c.features['markers'];
markers.map(x=>x.setMap(null));
markers.length = 0;
// draw markers
var lines = load['lines'];
lines.map(x=>drawMarker(x.latlngs[0],c.map,markers));

// markers to map
_markersMap = {}; 
for(var i in markers){
	var marker = markers[i];
	var line = lines[i];
	var key = marker.getPosition().lat()+'-'+marker.getPosition().lng();
	_markersMap[key]={'marker':marker,'terr':'','line':line.latlngs};
	marker.setTitle('');
}
// fill from gos
for(var i in gos){
	var key = gos[i]['south']+'-'+gos[i]['west'];
	var terr = gos[i]['name'];
	var obj = _markersMap[key];
	if(obj){
		obj['marker'].setTitle(terr);
		obj['terr']=terr; // in markers only
	} 
}

// markers to cols
var i=0, cols=load.cols;
cols.map(x=>{
	x.map(y=>{
		y.marker = markers[i];
		i++;
	});
});

// on html
var fg = document.getElementById('feature_grid');
var c0 = fg.children[0];
// clean before append
while(fg.children.length > 1){ fg.lastChild.remove(); }

// process cols & rows
for(var i=0;i<cols.length;i++){
	var cN = c0.cloneNode(true);
	var rows = cols[i];
	for(var j=0;j<rows.length;j++){
		var line = rows[j];
		let marker = line.marker, btn=cN.children[j];
		let terr = marker.getTitle();
		// new btn
		if(!btn){
			var input = c0.children[0].cloneNode(true);
			// even odd
			if(j%2!=0) input.classList.add('even');
			// !_isOD revert
			if(!_isOD) input.classList.remove('even');
			cN.appendChild(input);
			btn=cN.children[j];
		}
		// set cols 
		if(terr.length==0){
			btn.value = ' ';		
		}else{
			if(_list1[terr]){
				btn.value = _list1[terr][0];
				btn.classList.add(terr);
				// marker
				marker.setIcon({'url':_list1[terr][1],'scaledSize':new google.maps.Size(32,32)});
			}
		} 
		// marker & btn event
		let event = ()=>{
			var terr = marker.getTitle();
			var j = arrNextIndex(_list2,terr);
			var terr2 = _list2[j];
			marker.setTitle(terr2);
			marker.setIcon({'url':_list1[terr2][1],'scaledSize':new google.maps.Size(32,32)}); 
			// btn
			btn.value=_list1[terr2][0];
			if(btn.classList.contains(terr)) btn.classList.remove(terr);
			btn.classList.add(terr2);
			// map
			var key = marker.getPosition().lat()+'-'+marker.getPosition().lng();
			_markersMap[key]['terr']=terr2;
			};

		marker.addListener('click',event); 
		btn.addEventListener('click',event);
	} // for j
	fg.appendChild(cN);
} // for i	

_kml['load']=load;

};

c.click_grid = (e)=>{

if(_isGM){ c.grid_GM(e);return false;}

      var lat = e.latLng.lat() ; 
      var lng = e.latLng.lng() ;
	  var max = _gridNow['max'];
	  var per = _gridNow['per'];

	  let map = c.map;

	  var boxs = [];
	  var lines = [];
	// from features
	var polylines = c.features['polylines'];
	// clear lines
	polylines.map(x=>x.setMap(null));
	polylines.length = 0;
		
	var calc = (lat,lng,max,per,boxs,lines,polylines,map,isInfo)=>{

	var d = getDecimal(max);
	var oe = getOddExt(d,lng);
	var latlng = getLatlng(lat,lng);	
	var latlngWS = getLatlngWS(latlng);
	var lat0 = latlngWS.lat();
	var lng0 = latlngWS.lng();
	// draw outer box
	var latlng00 = getLatlng(lat0,lng0);
	var latlng01 = getLatlng(lat0,round(lng0+max,d));
	var latlng11 = getLatlng(round(lat0+max,d+oe),round(lng0+max,d));
 	var latlng10 = getLatlng(round(lat0+max,d+oe),lng0);
	var box = {'name':lat0+','+lng0,'latlngs':[latlng00,latlng01,latlng11,latlng10,latlng00]};
	boxs.push(box);
	drawLine(box.latlngs,map,polylines);
	
	// info
	gridInfo(lat0,lng0,'latlng');
	// calc all small west south point with per
	// start with west north
var cols=[], latlngWN = getLatlng(round(lat0+max-per,d+oe+1),lng0);
var colsMax = parseInt(max/per), rowsMax = parseInt(max/per);
		for (var i = 0; i < colsMax; i++) {
			var row = [];
			for (j = 0; j < rowsMax; j++) {
				var lng = latlngWN.lng() + per * j;
				var lat = latlngWN.lat() - per * i;
				// when row even shifting half -
				if (j % 2 != 0) lat = latlngWN.lat() - per * i - per / 2;
				// !_isOD revert
				if(!_isOD) lat = lat = latlngWN.lat() - per * i;
				lat = round(lat,d+2);
				lng = round(lng,d+2);
				// wn lat lng to a grid
				var n = {
					'sw': [lat, lng]
					, 'wn': [lat, round(lng + per, d + 2)]
					, 'en': [round(lat + per, d + 2), round(lng + per, d + 2)]
					, 'es': [round(lat + per, d + 2), lng]
				};
				// convert to latlng
				var latlngs = [n.sw, n.wn, n.en, n.es, n.sw];
				latlngs=latlngs.map(x=>getLatlng(x[0],x[1]));
				drawLine(latlngs,map,polylines,_colorSet.grid);
				row[j] = { 'name': lat + ',' + lng, 'latlngs': latlngs };
				lines.push(row[j]);
	}
			cols[i] = row;
			} 

	};

	calc(lat,lng,max,per,boxs,lines,polylines,map,true);
	
// load kml
var xmlDoc = getXmlDoc('kml_in');

var placemarks = xmlDoc.getElementsByTagName('Placemark');
var polygons = xmlDoc.getElementsByTagName('Polygon');
// kml name
var box = boxs[0];
var name = box.name;
var names = xmlDoc.getElementsByTagName('name');
names[0].textContent = 'san2-'+name;
names[names.length-1].textContent = name;
// polygon value
var txts = [];
box.latlngs.map((a,i)=>{txts.push(a.lng()+','+a.lat()+',0')});
	// coordinate
	polygons[0].getElementsByTagName('coordinates')[0].textContent = txts.join(' ');
// line
for(var i = 0 ; i < lines.length; i++){
	var line = lines[i];
	var txts = [];
	line.latlngs.map((a,i)=>{txts.push(a.lng()+','+a.lat()+',0')});
	var name = line.name;
	var placemark = placemarks[0].cloneNode(true);
	placemark.getElementsByTagName('name')[0].textContent = name;
	placemark.getElementsByTagName('coordinates')[0].textContent = txts.join(' ');
	xmlDoc.getElementsByTagName('Folder')[0].appendChild(placemark);
	}
// remove sample placemark
var x = xmlDoc.getElementsByTagName("Placemark")[0];
x.parentNode.removeChild(x);
// delete default groundoverlay
var x = xmlDoc.getElementsByTagName("GroundOverlay")[0];
x.parentNode.removeChild(x);

putXmlDoc('kml_out',xmlDoc);
// boxs & lines 
_kml['click']={'boxs':boxs,'lines':lines};

return {'boxs':boxs,'lines':lines}

};

c.data_sort = ()=>{

if(_isGM){c.load_GM();return false;}
  // process xml
var xmlDoc = getXmlDoc('data');

var gos=[], groundOverlays = xmlDoc.getElementsByTagName('GroundOverlay');
var mx = _multiple;
var d = getDecimal(_gridNow['max'])+1;
// round
for(var i=0, total=groundOverlays.length; i < total;i++){
	var go = groundOverlays[i];
	var southStr = go.getElementsByTagName('south')[0].textContent;
	var westStr = go.getElementsByTagName('west')[0].textContent;
	var northStr = go.getElementsByTagName('north')[0].textContent;
	var eastStr = go.getElementsByTagName('east')[0].textContent;
	var name = go.getElementsByTagName('name')[0].textContent;
	var south = round(round(parseFloat(southStr)/mx,d+1)*mx,d+1);
	var west = round(parseFloat(westStr),d);
	var north = round(round(parseFloat(northStr)/mx,d+1)*mx,d+1);
	var east = round(parseFloat(eastStr),d);
	var obj = {'south': south,
				'west': west,
				'north': north,
				'east': east,
				'name': name,
				'go': go	
			};
	gos[i] = obj;
	// rewrite round value
	go.getElementsByTagName('south')[0].textContent = south;
	go.getElementsByTagName('west')[0].textContent = west;
	go.getElementsByTagName('north')[0].textContent = north;
	go.getElementsByTagName('east')[0].textContent = east;		
	} 

// sort 
var ascendWest = (a,b)=>{return a['west']-b['west']}; // 小到大
var descendSouth = (a,b)=>{return b['south']-a['south']}; // 大到小

gos.sort(ascendWest);
gos.sort(descendSouth);

// append to folder named features
var txt='feature', featuresFolder = undefined, folders = xmlDoc.getElementsByTagName('Folder');
for(var i=0;i<folders.length;i++){
	if(folders[i].children[0].textContent == txt) featuresFolder = folders[i];
}
if(featuresFolder == undefined) featuresFolder = xmlDoc.getElementsByTagName('Document')[1];
for(var i=0, total=gos.length; i < total;i++) featuresFolder.appendChild(gos[i]['go']); 

putXmlDoc('data',xmlDoc);

// call click_grid
var last = gos.length-1;
var load = {};

if(last <= 0){
	var placemark = xmlDoc.getElementsByTagName('Placemark')[0];
	if(!placemark){alert('no placemark');return false;}
	var arr = placemark.textContent.split('#')[0].split(',');
	var e = {'latLng': getLatlng(arr[0],arr[1]) };
	load = c.click_grid(e,c.map,c.features);
	
}else{
	var e = {'latLng':getLatlng(gos[0]['south'], gos[0]['west'])};
	load = c.click_grid(e,c.map,c.features);
} 

if(load['boxs'][0].latlngs[0].lat()==90){alert('error');return false;}

// fit bound with grid
	var boxs = load['boxs'], bounds = new google.maps.LatLngBounds();
	bounds.extend(boxs[0].latlngs[0]);
	bounds.extend(boxs[0].latlngs[2]);
	c.map.fitBounds(bounds);

//clear marker first
var markers = c.features['markers'];
markers.map(x=>x.setMap(null));
			markers.length = 0;
// draw markers
var lines = load['lines'];
lines.map(x=>drawMarker(x.latlngs[0],c.map,markers));

// markers to map
_markersMap = {}; 
for(var i in markers){
	var marker = markers[i];
	var line = lines[i];
	var key = marker.getPosition().lat()+'-'+marker.getPosition().lng();
	_markersMap[key]={'marker':marker,'terr':'','line':line.latlngs};
	marker.setTitle('');
}
// fill from gos
for(var i in gos){
	var key = gos[i]['south']+'-'+gos[i]['west'];
	var terr = gos[i]['name'];
	var obj = _markersMap[key]; 
	if(obj){
		obj['terr']=terr; 
		obj['marker'].setTitle(terr);
	} 
}

// on html
var fg = document.getElementById('feature_grid');
var row0 = fg.children[0];
// clean before append
while(fg.children.length > 1){ fg.lastChild.remove(); }

// split markers per divide
var rows =[], div = parseInt(_gridNow['max']/_gridNow['per']);
for (var i = 0; i < markers.length; i += div) {
    var chunk = markers.slice(i, i + div);
	rows.push(chunk);	
}
// process rows & cols
for(var i=0;i<rows.length;i++){
	var rowN = row0.cloneNode(true);
	var cols = rows[i];
	for(var j=0;j<cols.length;j++){
		let marker = cols[j], btn=rowN.children[j];
		let terr=marker.getTitle();
		// set cols 
		if(terr.length==0){
			btn.value = ' ';		
		}else{
			if(_list1[terr]){
				btn.value = _list1[terr][0];
				btn.classList.add(terr);
				// marker
				marker.setIcon({'url':_list1[terr][1],'scaledSize':new google.maps.Size(32,32)});
				marker.setTitle(terr);
			}
		}
		// marker & btn event
		let event = ()=>{
			var terr = marker.getTitle();
			var j = arrNextIndex(_list2,terr);
			var terr2 = _list2[j];
			marker.setTitle(terr2);
			marker.setIcon({'url':_list1[terr2][1],'scaledSize':new google.maps.Size(32,32)}); 
			// btn
			btn.value=_list1[terr2][0];
			if(btn.classList.contains(terr)) btn.classList.remove(terr);
			btn.classList.add(terr2);
			// map
			_markersMap[marker.getPosition().lat()+'-'+marker.getPosition().lng()]['terr']=terr2;
		};

		marker.addListener('click',event); 
		btn.addEventListener('click',event);
	}
	fg.appendChild(rowN);
}

_kml['load']=load;

 };

 c.kml_write = ()=>{
	 // load kml
	var load = _kml['load'];
	var box = load['boxs'][0];
	var lines = load['lines'];
	
	var xmlDoc = getXmlDoc('kml_in');

	 var placemarks = xmlDoc.getElementsByTagName('Placemark');
	 var polygons = xmlDoc.getElementsByTagName('Polygon');
	 // kml name : polygon coor
	 var name = box.name;
	 var names = xmlDoc.getElementsByTagName('name');
	 names[0].textContent = 'san2-' + name;
	 names[names.length - 1].textContent = name;
	 // polygon value
	 var txts = [];
	 box.latlngs.map((a, i) => { txts.push(a.lng() + ',' + a.lat() + ',0') });
	 // coordinate
	 polygons[0].getElementsByTagName('coordinates')[0].textContent = txts.join(' ');
	 // line
	 for (var i = 0; i < lines.length; i++) {
		 var line = lines[i];
		 var txts = [];
		 line.latlngs.map((a, i) => { txts.push(a.lng() + ',' + a.lat() + ',0') });
		 var name = line.name;
		 var placemark = placemarks[0].cloneNode(true);
		 placemark.getElementsByTagName('name')[0].textContent = name;
		 placemark.getElementsByTagName('coordinates')[0].textContent = txts.join(' ');
		 xmlDoc.getElementsByTagName('Folder')[0].appendChild(placemark);
	 }
	 // groundOverlay
	 var go = xmlDoc.getElementsByTagName('GroundOverlay')[0];
	 var folder = xmlDoc.getElementsByTagName('Folder')[1];
	 for(var key in _markersMap){	
		var obj = _markersMap[key];
		var name = obj['terr'];
		if(name.length == 0) continue;
		var line = obj['line'];
		var goN = go.cloneNode(true);
		goN.getElementsByTagName('south')[0].textContent = line[0].lat();
		goN.getElementsByTagName('west')[0].textContent = line[0].lng();
		goN.getElementsByTagName('north')[0].textContent = line[2].lat();
		goN.getElementsByTagName('east')[0].textContent = line[2].lng();
		goN.getElementsByTagName('href')[0].textContent = _list1[name][1];
		goN.getElementsByTagName('name')[0].textContent = name;
		folder.appendChild(goN);
	 }

	 // remove sample placemark
	 var x = xmlDoc.getElementsByTagName("Placemark")[0];
	 x.parentNode.removeChild(x);
	 // delete default groundoverlay
	 var x = xmlDoc.getElementsByTagName("GroundOverlay")[0];
	 x.parentNode.removeChild(x);

	 putXmlDoc('data',xmlDoc);
 };

})(latlng_map_tile);


function startMap() {
	
	let map;
	let features = {
		markers:[]
		,polylines:[]
	};
	
    var centerPoint = new google.maps.LatLng(23.74, 120.96);
      
      var mapSetting = {
      zoom: 7,
      center: centerPoint,
      scaleControl: true,
      streetViewControl: true,
      mapTypeId: google.maps.MapTypeId.TERRAIN,
      gestureHandling: "greedy",
	  //tilt: 45,
	  //mapId:"2ac8a2c068ebc12d"
      }; 
      // 放大值,中心點,比例尺,街景功能,地圖種類(一定要有)
      
      map = new google.maps.Map(document.getElementById("map-canvas"), mapSetting);

	  latlng_map_tile.map = map;
	  latlng_map_tile.features = features;
	
      google.maps.event.addListener(map,'click',latlng_map_tile.click_grid);
}
      
</script>  
  </head>
<body onload="">
    <div class="container">
		<div id="css_table">
			<div class="css_tr">
					<div class="css_td" >
						<div id="map-canvas"></div>
					</div>
					<div class="css_td">
						<div style="position: absolute;">
							<span>
								<h1>info</h1>
								<div id="info"></div>
							</span>
							<span style="display:none">
								<h1>kml unit</h1>
								<textarea id="kml_in">
									<?xml version="1.0" encoding="UTF-8"?>
									<kml xmlns="http://www.opengis.net/kml/2.2" xmlns:gx="http://www.google.com/kml/ext/2.2" xmlns:kml="http://www.opengis.net/kml/2.2" xmlns:atom="http://www.w3.org/2005/Atom">
									<Document>
										<name>meow</name>
										<open>1</open>
										<StyleMap id="m_ylw-pushpin">
											<Pair>
												<key>normal</key>
												<styleUrl>#s_ylw-pushpin</styleUrl>
											</Pair>
											<Pair>
												<key>highlight</key>
												<styleUrl>#s_ylw-pushpin_hl</styleUrl>
											</Pair>
										</StyleMap>
										<Style id="s_ylw-pushpin">
											<IconStyle>
												<scale>1.1</scale>
												<Icon>
													<href>http://maps.google.com/mapfiles/kml/pushpin/ylw-pushpin.png</href>
												</Icon>
												<hotSpot x="20" y="2" xunits="pixels" yunits="pixels"/>
											</IconStyle>
										</Style>
										<Style id="s_ylw-pushpin_hl">
											<IconStyle>
												<scale>1.3</scale>
												<Icon>
													<href>http://maps.google.com/mapfiles/kml/pushpin/ylw-pushpin.png</href>
												</Icon>
												<hotSpot x="20" y="2" xunits="pixels" yunits="pixels"/>
											</IconStyle>
										</Style>
										<StyleMap id="m_ylw-pushpin234">
											<Pair>
												<key>normal</key>
												<styleUrl>#s_ylw-pushpin254</styleUrl>
											</Pair>
											<Pair>
												<key>highlight</key>
												<styleUrl>#s_ylw-pushpin_hl254</styleUrl>
											</Pair>
										</StyleMap>
										<Style id="s_ylw-pushpin254">
											<IconStyle>
												<scale>1.1</scale>
												<Icon>
													<href>http://maps.google.com/mapfiles/kml/pushpin/ylw-pushpin.png</href>
												</Icon>
												<hotSpot x="20" y="2" xunits="pixels" yunits="pixels"/>
											</IconStyle>
											<PolyStyle>
												<color>00ffffff</color>
											</PolyStyle>
										</Style>
										<Style id="s_ylw-pushpin_hl254">
											<IconStyle>
												<scale>1.3</scale>
												<Icon>
													<href>http://maps.google.com/mapfiles/kml/pushpin/ylw-pushpin.png</href>
												</Icon>
												<hotSpot x="20" y="2" xunits="pixels" yunits="pixels"/>
											</IconStyle>
											<PolyStyle>
												<color>00ffffff</color>
											</PolyStyle>
										</Style>
										<Folder>
											<name>grid</name>
											<Placemark>
												<name>box</name>
												<styleUrl>#m_ylw-pushpin</styleUrl>
												<LineString>
													<tessellate>1</tessellate>
													<coordinates>
														meow 
													</coordinates>
												</LineString>
											</Placemark>
										</Folder>
										<Folder>
											<name>feature</name>
											<GroundOverlay>
												<name>meow</name>
												<visibility>1</visibility>
												<Icon>
													<href>meow</href>
													<viewBoundScale>0.75</viewBoundScale>
												</Icon>
												<LatLonBox>
													<north>meow</north>
													<south>meow</south>
													<east>meow</east>
													<west>meow</west>
												</LatLonBox>
											</GroundOverlay>
										</Folder>
										<Placemark>
												<name>meow</name>
												<styleUrl>#m_ylw-pushpin234</styleUrl>
												<Polygon>
													<tessellate>1</tessellate>
													<outerBoundaryIs>
														<LinearRing>
															<coordinates>
																meow 
															</coordinates>
														</LinearRing>
													</outerBoundaryIs>
												</Polygon>
										</Placemark>
									</Document>
									</kml>
								</textarea>
							</span>
							<span>
								<h1>kml grid
									<input type="button" id="isOD" class="active" value="OD"/>
									<input type="button" id="grid_level" value="10 km"/>
									<input type="button" id="isGM" value="isGM"/>
									<input type="button" id="grid_GM_latlng" value="latlng-GM"/>
									</h1>	
								<textarea id="kml_out"></textarea>
								<button id="kml_copy">copy</button>
							</span>
							<span>
								<h1>feature
									<button id="kml_write">write</button>
									</h1>
								<div id="feature_grid">
									<div class="css_tr">
										<input type="button" class="fr" value="1"/>
										<input type="button" class="fr even" value="2"/>
										<input type="button" class="fr" value="3"/>
										<input type="button" class="fr even" value="4"/>
										<input type="button" class="fr" value="5"/>
										<input type="button" class="fr even" value="6"/>
										<input type="button" class="fr" value="7"/>
										<input type="button" class="fr even" value="8"/>
										<input type="button" class="fr" value="9"/>
										<input type="button" class="fr even" value="10"/>
									</div>
								</div>
							</span>
						<span>
							<h1>kml load (round & sort)</h1>
							<textarea id="data"></textarea>
							<button id="data_sort" >load</button>
							<button id="load_GM_latlng" >load latlng-GM</button>
						</span>
						<!--
							<img class="lat" src="./pic/22-120-10.png"/>
							<img class="lat" src="./pic/22-121-10.png"/>
							<img class="lat" src="./pic/23-120-10.png"/>
						-->
						</div>
					</div>
			</div>
	  </div>
	</div>
	<div  style="display:block">
	
	</div>
</body>
</html>
<script>

(()=>{

  if(window.google && window.google.maps){
      // the map API is already be loaded (from a previous button click, maybe)
      startMap();
  
  } else if(!document.getElementById('google-map-script')) {
      // the script tag is not present so add it to the DOM
      var scriptTag = document.createElement('script');
      scriptTag .id = 'google-map-script';
      scriptTag .src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyBPWqfY7rCCyz-Xda_npvhfkIdK2vRfeFM&callback=startMap';
      var head = document.getElementsByTagName('head')[0];
      head.appendChild(scriptTag);
  }

	//html event bind
	document.getElementById('kml_copy').addEventListener('click',()=>{
    	document.getElementById('kml_out').select();
    	document.execCommand('copy');
  	});	
	
	var data_sort = latlng_map_tile.data_sort;
	document.getElementById('data_sort').addEventListener('click',data_sort);

	var kml_write = latlng_map_tile.kml_write;
	document.getElementById('kml_write').addEventListener('click',kml_write);

	var gridLevelChange = latlng_map_tile.gridLevelChange;
	document.getElementById('grid_level').addEventListener('click',gridLevelChange);

	document.getElementById('grid_GM_latlng').addEventListener('click',latlng_map_tile.grid_GM_latlng);

	document.getElementById('load_GM_latlng').addEventListener('click',()=>{
		latlng_map_tile.load_GM(1);
	});

	document.getElementById('isGM').addEventListener('click',latlng_map_tile.isGM);

	document.getElementById('isOD').addEventListener('click',latlng_map_tile.isOD);

})();

</script>

